<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分支管理工具</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .container { max_width: 1000px; margin-top: 20px; }
        .card { margin-bottom: 20px; }
        .list-group-item-action { cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">分支管理工具</a>
        </div>
    </nav>

    <div class="container">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">同步历史</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="tasks-tab" data-bs-toggle="tab" data-bs-target="#tasks" type="button">同步任务</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="repos-tab" data-bs-toggle="tab" data-bs-target="#repos" type="button">仓库管理</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button">设置</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" type="button">统计</button>
            </li>
        </ul>

        <div class="tab-content pt-3" id="myTabContent">
            <!-- History Tab -->
            <div class="tab-pane fade show active" id="history" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>同步历史</h4>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()">刷新</button>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>任务ID</th>
                            <th>状态</th>
                            <th>耗时</th>
                            <th>信息</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="history-list"></tbody>
                </table>
            </div>

            <!-- Tasks Tab -->
            <div class="tab-pane fade" id="tasks" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>同步任务</h4>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">新建任务</button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>源</th>
                            <th>目标</th>
                            <th>Cron</th>
                            <th>启用</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="task-list">
                        <tr>
                            <td colspan="6" class="text-center">加载中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Repos Tab -->
            <div class="tab-pane fade" id="repos" role="tabpanel">
                <div class="d-flex justify-content-between mb-3">
                    <h4>仓库列表</h4>
                    <button class="btn btn-primary btn-sm" onclick="openAddRepoModal()">注册仓库</button>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>路径</th>
                            <th>环境</th>
                            <th>远程</th>
                        </tr>
                    </thead>
                    <tbody id="repo-list"></tbody>
                </table>
            </div>

            <!-- Settings Tab -->
            <div class="tab-pane fade" id="settings" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">系统配置</h5>
                        <div class="form-check form-switch mt-3">
                            <input class="form-check-input" type="checkbox" id="debugModeSwitch" onchange="toggleDebugMode()">
                            <label class="form-check-label" for="debugModeSwitch">开启调试模式 (Debug Mode)</label>
                        </div>
                        <div class="form-text mt-2">开启后，系统将在后台日志中输出详细的 Git 命令执行信息。</div>
                    </div>
                </div>
                <div class="card mt-3">
                     <div class="card-body">
                        <h5 class="card-title">API 文档</h5>
                        <p>查看在线 Swagger 文档：<a href="/docs/index.html" target="_blank">Swagger UI</a></p>
                     </div>
                </div>
            </div>

            <!-- Stats Tab -->
            <div class="tab-pane fade" id="stats" role="tabpanel">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">选择仓库</label>
                        <select class="form-select" id="statsRepoSelect" onchange="loadStatsBranches()"></select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">选择分支</label>
                        <select class="form-select" id="statsBranchSelect" onchange="loadStatsData()"></select>
                    </div>
                    <div class="col-md-6 d-flex align-items-end">
                        <button class="btn btn-primary me-2" onclick="loadStatsData()">分析</button>
                        <button class="btn btn-outline-success" onclick="exportStatsCSV()">导出 CSV</button>
                    </div>
                </div>

                <!-- Dashboard -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center text-bg-primary mb-3">
                            <div class="card-body">
                                <h5 class="card-title">总有效行数</h5>
                                <h2 class="display-6" id="totalLines">0</h2>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-center text-bg-success mb-3">
                            <div class="card-body">
                                <h5 class="card-title">活跃贡献者</h5>
                                <h2 class="display-6" id="totalAuthors">0</h2>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">贡献分布 (有效行数)</h5>
                                <div id="pieChart" style="height: 350px;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">贡献趋势 (近30天)</h5>
                                <div id="lineChart" style="height: 350px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Commits Table -->
                <div class="card">
                    <div class="card-header">提交历史 (最近 100 条)</div>
                    <div class="card-body">
                         <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Hash</th>
                                    <th>作者</th>
                                    <th>时间</th>
                                    <th>信息</th>
                                </tr>
                            </thead>
                            <tbody id="commitsList">
                                <tr><td colspan="4" class="text-center">请选择仓库和分支进行分析</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Repo Modal -->
    <div class="modal fade" id="addRepoModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">注册仓库</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="repoTabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#repo-basic" type="button">基本信息</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#repo-remote" type="button">远程与认证</button>
                        </li>
                    </ul>
                    <form id="addRepoForm">
                        <div class="tab-content">
                            <!-- Basic Info -->
                            <div class="tab-pane fade show active" id="repo-basic">
                                <div class="mb-3">
                                    <label class="form-label">名称</label>
                                    <input type="text" class="form-control" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">本地路径</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="path" id="localPathInput" placeholder="/path/to/repo" required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="openFileBrowser()">浏览...</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">环境</label>
                                    <select class="form-select" name="environment">
                                        <option value="dev">开发 (Dev)</option>
                                        <option value="test">测试 (Test)</option>
                                        <option value="prod">生产 (Prod)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Remote & Auth -->
                            <div class="tab-pane fade" id="repo-remote">
                                <div class="mb-3">
                                    <label class="form-label">远程 URL</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" name="remote_url" id="repoRemoteUrl" placeholder="git@github.com:user/repo.git">
                                        <button class="btn btn-outline-primary" type="button" onclick="testRepoConnection()">测试连接</button>
                                    </div>
                                    <div id="repoTestResult" class="form-text"></div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">认证方式</label>
                                    <select class="form-select" name="auth_type" onchange="toggleAuthFields()">
                                        <option value="none">无 (None)</option>
                                        <option value="ssh">SSH 密钥</option>
                                        <option value="http">用户名/密码 (HTTP/HTTPS)</option>
                                    </select>
                                </div>
                                
                                <div id="auth-ssh" class="d-none">
                                    <div class="mb-3">
                                        <label class="form-label">SSH 密钥</label>
                                        <div class="input-group">
                                            <select class="form-select" name="auth_key_select" id="sshKeySelect" onchange="document.getElementsByName('auth_key')[0].value=this.value">
                                                <option value="">手动输入路径...</option>
                                            </select>
                                            <input type="text" class="form-control" name="auth_key" placeholder="~/.ssh/id_rsa">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">密钥密码 (Passphrase)</label>
                                        <input type="password" class="form-control" name="auth_secret_ssh">
                                    </div>
                                </div>
                                
                                <div id="auth-http" class="d-none">
                                    <div class="mb-3">
                                        <label class="form-label">用户名</label>
                                        <input type="text" class="form-control" name="auth_user">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">密码 / Token</label>
                                        <input type="password" class="form-control" name="auth_secret_http">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitRepo()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Browser Modal -->
    <div class="modal fade" id="fileBrowserModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择目录</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <div class="input-group">
                             <button class="btn btn-outline-secondary" onclick="loadDirs(currentParentPath)"><i class="bi bi-arrow-up"></i> 上一级</button>
                             <input type="text" class="form-control" id="currentPathDisplay" readonly>
                        </div>
                    </div>
                    <div class="mb-2">
                         <input type="text" class="form-control" id="fileSearchInput" placeholder="搜索当前目录..." oninput="searchDirs()">
                    </div>
                    <div class="list-group" id="dirList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Dirs loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="selectCurrentDir()">选择当前目录</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">创建同步任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label class="form-label">源仓库</label>
                            <select class="form-select" name="source_repo_id" id="sourceRepoSelect" onchange="updateTargetRepo(this.value)" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">源 Remote</label>
                                <input type="text" class="form-control" name="source_remote" value="origin" required>
                            </div>
                            <div class="col">
                                <label class="form-label">源分支</label>
                                <input type="text" class="form-control" name="source_branch" value="main" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">目标仓库</label>
                            <select class="form-select" name="target_repo_id" id="targetRepoSelect" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">目标 Remote</label>
                                <input type="text" class="form-control" name="target_remote" value="ky" required>
                            </div>
                            <div class="col">
                                <label class="form-label">目标分支</label>
                                <input type="text" class="form-control" name="target_branch" value="main" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Push 选项</label>
                            <input type="text" class="form-control" name="push_options" placeholder="例如: --force --no-verify">
                            <div class="form-text">可选参数，将直接传递给 git push 命令</div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Cron 表达式</label>
                            <input type="text" class="form-control" name="cron" placeholder="0 2 * * *">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="enabled" checked>
                            <label class="form-check-label">启用</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑同步任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editTaskForm">
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label class="form-label">源仓库</label>
                            <select class="form-select" name="source_repo_id" id="editSourceRepoSelect" onchange="updateEditTargetRepo(this.value)" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">源 Remote</label>
                                <input type="text" class="form-control" name="source_remote" required>
                            </div>
                            <div class="col">
                                <label class="form-label">源分支</label>
                                <input type="text" class="form-control" name="source_branch" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">目标仓库</label>
                            <select class="form-select" name="target_repo_id" id="editTargetRepoSelect" required></select>
                        </div>
                        <div class="row">
                            <div class="col">
                                <label class="form-label">目标 Remote</label>
                                <input type="text" class="form-control" name="target_remote" required>
                            </div>
                            <div class="col">
                                <label class="form-label">目标分支</label>
                                <input type="text" class="form-control" name="target_branch" required>
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Push 选项</label>
                            <input type="text" class="form-control" name="push_options" placeholder="例如: --force --no-verify">
                            <div class="form-text">可选参数，将直接传递给 git push 命令</div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label">Cron 表达式</label>
                            <input type="text" class="form-control" name="cron" placeholder="0 2 * * *">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="enabled">
                            <label class="form-check-label">启用</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" onclick="submitEditTask()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Modal -->
    <div class="modal fade" id="logModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">执行日志</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="logContent" style="background: #f8f9fa; padding: 10px; max-height: 500px; overflow-y: auto; white-space: pre-wrap;"></pre>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script>
        const API_BASE = '/api';

        // Load data on start
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            loadRepos();
            loadTasks();
            loadConfig();
            loadStatsRepos();
        });

        async function loadConfig() {
            try {
                const res = await fetch(`${API_BASE}/config`);
                const data = await res.json();
                document.getElementById('debugModeSwitch').checked = data.debug_mode;
            } catch (e) {
                console.error("Failed to load config", e);
            }
        }

        async function toggleDebugMode() {
            const enabled = document.getElementById('debugModeSwitch').checked;
            try {
                await fetch(`${API_BASE}/config`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({debug_mode: enabled})
                });
            } catch (e) {
                alert("设置失败");
                // Revert
                document.getElementById('debugModeSwitch').checked = !enabled;
            }
        }

        async function loadHistory() {
            const res = await fetch(`${API_BASE}/sync/history`);
            const data = await res.json();
            const tbody = document.getElementById('history-list');
            tbody.innerHTML = '';
            data.forEach(run => {
                const tr = document.createElement('tr');
                const duration = run.end_time ? (new Date(run.end_time) - new Date(run.start_time)) + 'ms' : '-';
                tr.innerHTML = `
                    <td>${new Date(run.start_time).toLocaleString()}</td>
                    <td>${run.task_id}</td>
                    <td><span class="badge bg-${getStatusColor(run.status)}">${run.status}</span></td>
                    <td>${duration}</td>
                    <td>${run.error_message || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick='showLog(${JSON.stringify(run.details || "暂无日志")})'>查看日志</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function showLog(details) {
            document.getElementById('logContent').textContent = details;
            new bootstrap.Modal(document.getElementById('logModal')).show();
        }

        function getStatusColor(status) {
            if (status === 'success') return 'success';
            if (status === 'failed') return 'danger';
            if (status === 'conflict') return 'warning';
            return 'secondary';
        }

        async function loadRepos() {
            const res = await fetch(`${API_BASE}/repos`);
            const data = await res.json();
            const tbody = document.getElementById('repo-list');
            tbody.innerHTML = '';
            const sourceSelect = document.getElementById('sourceRepoSelect');
            const targetSelect = document.getElementById('targetRepoSelect');
            sourceSelect.innerHTML = '';
            targetSelect.innerHTML = '';

            data.forEach(repo => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${repo.id}</td>
                    <td>${repo.name}</td>
                    <td>${repo.path}</td>
                    <td><span class="badge bg-info text-dark">${repo.environment || 'N/A'}</span></td>
                    <td>${repo.remote_url || '-'}</td>
                `;
                tbody.appendChild(tr);

                const option = `<option value="${repo.id}">${repo.name}</option>`;
                sourceSelect.innerHTML += option;
                targetSelect.innerHTML += option;
            });
        }

        function openAddRepoModal() {
            // Reset form
            document.getElementById('addRepoForm').reset();
            toggleAuthFields();
            loadSSHKeys();
            new bootstrap.Modal(document.getElementById('addRepoModal')).show();
        }

        function toggleAuthFields() {
            const type = document.getElementsByName('auth_type')[0].value;
            document.getElementById('auth-ssh').className = type === 'ssh' ? 'd-block' : 'd-none';
            document.getElementById('auth-http').className = type === 'http' ? 'd-block' : 'd-none';
        }

        async function loadSSHKeys() {
            const res = await fetch(`${API_BASE}/system/ssh-keys`);
            if (!res.ok) return;
            const keys = await res.json();
            const select = document.getElementById('sshKeySelect');
            select.innerHTML = '<option value="">手动输入路径...</option>';
            keys.forEach(key => {
                select.innerHTML += `<option value="${key.path}">${key.name}</option>`;
            });
        }

        async function testRepoConnection() {
            const url = document.getElementById('repoRemoteUrl').value;
            if (!url) {
                alert('请输入 URL');
                return;
            }
            const resLabel = document.getElementById('repoTestResult');
            resLabel.innerText = '测试中...';
            resLabel.className = 'form-text text-muted';

            try {
                const res = await fetch(`${API_BASE}/git/test-connection`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({url: url})
                });
                const data = await res.json();
                if (data.status === 'success') {
                    resLabel.innerText = '连接成功';
                    resLabel.className = 'form-text text-success fw-bold';
                } else {
                    resLabel.innerText = '失败: ' + data.error;
                    resLabel.className = 'form-text text-danger';
                }
            } catch (e) {
                resLabel.innerText = '请求错误';
                resLabel.className = 'form-text text-danger';
            }
        }

        async function submitRepo() {
            const form = document.getElementById('addRepoForm');
            
            // Gather Auth Data
            const authType = form.auth_type.value;
            let authKey = "";
            let authSecret = "";
            
            if (authType === 'ssh') {
                authKey = form.auth_key.value;
                authSecret = form.auth_secret_ssh.value;
            } else if (authType === 'http') {
                authKey = form.auth_user.value;
                authSecret = form.auth_secret_http.value;
            }

            const data = {
                name: form.name.value,
                path: form.path.value,
                remote_url: form.remote_url.value,
                environment: form.environment.value,
                auth_type: authType,
                auth_key: authKey,
                auth_secret: authSecret
            };

            const res = await fetch(`${API_BASE}/repos`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addRepoModal')).hide();
                loadRepos();
                form.reset();
            } else {
                const err = await res.json();
                alert('添加仓库失败: ' + (err.error || 'Unknown error'));
            }
        }

        // File Browser
        let currentParentPath = "";
        let currentPath = "";

        function openFileBrowser() {
            new bootstrap.Modal(document.getElementById('fileBrowserModal')).show();
            loadDirs(""); // Load default/home
        }

        function searchDirs() {
            const query = document.getElementById('fileSearchInput').value;
            loadDirs(currentPath, query);
        }

        async function loadDirs(path, search = "") {
            const res = await fetch(`${API_BASE}/system/dirs?path=${encodeURIComponent(path)}&search=${encodeURIComponent(search)}`);
            if (!res.ok) return;
            const data = await res.json();
            
            currentPath = data.current;
            currentParentPath = data.parent;
            
            document.getElementById('currentPathDisplay').value = data.current;
            
            const list = document.getElementById('dirList');
            list.innerHTML = '';
            
            data.dirs.forEach(d => {
                const item = document.createElement('button');
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `<i class="bi bi-folder"></i> ${d.name}`;
                item.onclick = () => {
                    // If we are searching, clicking a dir should open it and clear search
                    if (search) {
                         document.getElementById('fileSearchInput').value = "";
                         loadDirs(d.path, "");
                    } else {
                         loadDirs(d.path);
                    }
                };
                list.appendChild(item);
            });
        }

        function selectCurrentDir() {
            document.getElementById('localPathInput').value = currentPath;
            bootstrap.Modal.getInstance(document.getElementById('fileBrowserModal')).hide();
        }

        async function loadTasks() {
            const res = await fetch(`${API_BASE}/sync/tasks`);
            const data = await res.json();
            const tbody = document.getElementById('task-list');
            tbody.innerHTML = '';
            data.forEach(task => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${task.id}</td>
                    <td>${task.source_repo.name} (${task.source_remote}/${task.source_branch})</td>
                    <td>${task.target_repo.name} (${task.target_remote}/${task.target_branch})</td>
                    <td>${task.cron || '-'}</td>
                    <td>${task.enabled ? '是' : '否'}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="runTask(${task.id})">运行</button>
                        <button class="btn btn-sm btn-secondary" onclick="editTask(${task.id})">编辑</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateTargetRepo(sourceId) {
            document.getElementById('targetRepoSelect').value = sourceId;
        }

        function updateEditTargetRepo(sourceId) {
            document.getElementById('editTargetRepoSelect').value = sourceId;
        }

        async function editTask(id) {
            const res = await fetch(`${API_BASE}/sync/tasks/${id}`);
            if (!res.ok) {
                alert('获取任务失败');
                return;
            }
            const task = await res.json();
            
            // Populate form
            const form = document.getElementById('editTaskForm');
            form.id.value = task.id;
            
            // Need to populate selects first
            const reposRes = await fetch(`${API_BASE}/repos`);
            const repos = await reposRes.json();
            const sourceSelect = document.getElementById('editSourceRepoSelect');
            const targetSelect = document.getElementById('editTargetRepoSelect');
            sourceSelect.innerHTML = '';
            targetSelect.innerHTML = '';
            
            repos.forEach(repo => {
                const option = `<option value="${repo.id}">${repo.name}</option>`;
                sourceSelect.innerHTML += option;
                targetSelect.innerHTML += option;
            });
            
            form.source_repo_id.value = task.source_repo_id;
            form.source_remote.value = task.source_remote;
            form.source_branch.value = task.source_branch;
            form.target_repo_id.value = task.target_repo_id;
            form.target_remote.value = task.target_remote;
            form.target_branch.value = task.target_branch;
            form.push_options.value = task.push_options || '';
            form.cron.value = task.cron || '';
            form.enabled.checked = task.enabled;
            
            new bootstrap.Modal(document.getElementById('editTaskModal')).show();
        }

        async function submitEditTask() {
            const form = document.getElementById('editTaskForm');
            const id = form.id.value;
            const data = {
                source_repo_id: parseInt(form.source_repo_id.value),
                source_remote: form.source_remote.value,
                source_branch: form.source_branch.value,
                target_repo_id: parseInt(form.target_repo_id.value),
                target_remote: form.target_remote.value,
                target_branch: form.target_branch.value,
                push_options: form.push_options.value,
                cron: form.cron.value,
                enabled: form.enabled.checked
            };
            
            const res = await fetch(`${API_BASE}/sync/tasks/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('editTaskModal')).hide();
                loadTasks();
            } else {
                alert('更新任务失败');
            }
        }
        
        async function submitTask() {
            const form = document.getElementById('addTaskForm');
            const data = {
                source_repo_id: parseInt(form.source_repo_id.value),
                source_remote: form.source_remote.value,
                source_branch: form.source_branch.value,
                target_repo_id: parseInt(form.target_repo_id.value),
                target_remote: form.target_remote.value,
                target_branch: form.target_branch.value,
                push_options: form.push_options.value,
                cron: form.cron.value,
                enabled: form.enabled.checked
            };
            const res = await fetch(`${API_BASE}/sync/tasks`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            if (res.ok) {
                bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
                loadTasks();
                form.reset();
            } else {
                alert('创建任务失败');
            }
        }

        async function runTask(id) {
            const res = await fetch(`${API_BASE}/sync/run`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({task_id: id})
            });
            if (res.ok) {
                alert('同步已开始');
                setTimeout(loadHistory, 1000);
            } else {
                alert('启动同步失败');
            }
        }
        
        // Stats Logic
        async function loadStatsRepos() {
            const res = await fetch(`${API_BASE}/repos`);
            const repos = await res.json();
            const select = document.getElementById('statsRepoSelect');
            if (!select) return;
            select.innerHTML = '<option value="">请选择...</option>';
            repos.forEach(repo => {
                select.innerHTML += `<option value="${repo.id}">${repo.name}</option>`;
            });
        }
        
        async function loadStatsBranches() {
            const repoId = document.getElementById('statsRepoSelect').value;
            if (!repoId) return;
            const res = await fetch(`${API_BASE}/stats/branches?repo_id=${repoId}`);
            const branches = await res.json();
            const select = document.getElementById('statsBranchSelect');
            select.innerHTML = '';
            branches.forEach(b => {
                select.innerHTML += `<option value="${b}">${b}</option>`;
            });
        }
        
        let pieChart = null;
        let lineChart = null;
        
        async function loadStatsData() {
            const repoId = document.getElementById('statsRepoSelect').value;
            const branch = document.getElementById('statsBranchSelect').value;
            if (!repoId || !branch) return;
            
            const res = await fetch(`${API_BASE}/stats/analyze?repo_id=${repoId}&branch=${encodeURIComponent(branch)}`);
            const data = await res.json();
            
            document.getElementById('totalLines').innerText = data.total_lines.toLocaleString();
            document.getElementById('totalAuthors').innerText = data.authors.length;
            
            // Pie Chart
            if (!pieChart) pieChart = echarts.init(document.getElementById('pieChart'));
            pieChart.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'pie',
                    radius: '50%',
                    data: data.authors.map(a => ({value: a.total_lines, name: a.name})),
                    emphasis: { itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' } }
                }]
            });
            
            // Line Chart (Mock trend for now as API returns snapshot)
            // Real implementation would need history data
            if (!lineChart) lineChart = echarts.init(document.getElementById('lineChart'));
            // ... (Omitting complex chart config for brevity)
            
            loadCommits(repoId, branch);
        }
        
        async function loadCommits(repoId, branch) {
            const res = await fetch(`${API_BASE}/stats/commits?repo_id=${repoId}&branch=${encodeURIComponent(branch)}`);
            const commits = await res.json();
            const tbody = document.getElementById('commitsList');
            tbody.innerHTML = '';
            commits.slice(0, 100).forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><span class="text-monospace" title="${c.hash}">${c.hash.substring(0,7)}</span></td>
                    <td>${c.author}</td>
                    <td>${new Date(c.date).toLocaleString()}</td>
                    <td>${c.message}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function exportStatsCSV() {
             const repoId = document.getElementById('statsRepoSelect').value;
            const branch = document.getElementById('statsBranchSelect').value;
            if (!repoId || !branch) return;
            window.location.href = `${API_BASE}/stats/export/csv?repo_id=${repoId}&branch=${encodeURIComponent(branch)}`;
        }
    </script>
</body>
</html>
